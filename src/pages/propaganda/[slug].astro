---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import PropagandaPost from '../../layouts/PropagandaPost.astro';
import { marked } from 'marked';

export async function getStaticPaths() {
  const entries = await getCollection('propaganda');

  return entries.map((entry) => ({
    params: { slug: entry.id },
    props: entry,
  }));
}

type Props = CollectionEntry<'propaganda'>;

const entry = Astro.props as Props;
const { Content } = await render(entry);

// Computed fields for dossier aesthetic (no schema changes)
// NU = Negative Utopia file system prefix
const FILE_PREFIX = 'NU-';
const fileNo = `${FILE_PREFIX}${entry.id.toUpperCase().replace(/-/g, ' ')}`;
const classification = entry.data.type === 'poster' ? 'CONTROLLED' : 'RESTRICTED';
const displayYear = entry.data.year || 'UNKNOWN';
const displaySize = entry.data.printSize || 'STANDARD';
const displayTags = entry.data.tags?.length ? entry.data.tags.join(', ').toUpperCase() : 'NONE';

// Determine stamp text based on tags and type
const getStampText = () => {
  if (entry.data.tags?.includes('negative-utopia')) {
    return 'NEGATIVE UTOPIA';
  }
  return entry.data.type === 'poster' ? 'APPROVED' : 'ARCHIVED';
};
const stampText = getStampText();

// Split markdown body into report and inventory notes sections
const bodyText = entry.body;
const inventoryHeading = '## Inventory Control Notes';
const inventoryIndex = bodyText.indexOf(inventoryHeading);

let reportMd = bodyText;
let inventoryNotesMd = '';

if (inventoryIndex !== -1) {
  // Extract inventory notes section
  const afterHeading = bodyText.substring(inventoryIndex + inventoryHeading.length);
  // Find the next ## heading or end of file
  const nextHeadingMatch = afterHeading.match(/^## /m);
  const inventoryEnd = nextHeadingMatch 
    ? inventoryIndex + inventoryHeading.length + nextHeadingMatch.index 
    : bodyText.length;
  
  inventoryNotesMd = bodyText.substring(inventoryIndex + inventoryHeading.length, inventoryEnd).trim();
  
  // Remove the entire inventory section from report, preserving proper spacing
  const beforeSection = bodyText.substring(0, inventoryIndex).trimEnd();
  const afterSection = bodyText.substring(inventoryEnd).trimStart();
  reportMd = afterSection ? `${beforeSection}\n\n${afterSection}` : beforeSection;
}

// Render markdown to HTML
const reportHtml = marked.parse(reportMd);
const inventoryHtml = inventoryNotesMd ? marked.parse(inventoryNotesMd) : '';
---

<!-- Layout should NOT render an H1 under Option A -->
<PropagandaPost {...entry.data}>
  <div class="dossier">
    <!-- 1) Title + Stamp -->
    <header class="dossier-header">
      <h1>{entry.data.title}</h1>
      <div class="stamp" aria-label={`Stamp: ${stampText}`}>{stampText}</div>
    </header>

    <!-- 2) Classification strip -->
    <div class="classification-strip">
      <div class="strip-item">
        <span class="label">CLASSIFICATION</span>
        <span class="value">{classification}</span>
      </div>
      <div class="strip-item">
        <span class="label">FILE NO.</span>
        <span class="value">{fileNo}</span>
      </div>
      <div class="strip-item">
        <span class="label">YEAR</span>
        <span class="value">{displayYear}</span>
      </div>
      <div class="strip-item">
        <span class="label">MEDIUM</span>
        <span class="value">{entry.data.type.toUpperCase()}</span>
      </div>
      <div class="strip-item">
        <span class="label">SIZE</span>
        <span class="value">{displaySize}</span>
      </div>
      <div class="strip-item">
        <span class="label">TAGS</span>
        <span class="value">{displayTags}</span>
      </div>
    </div>

    <!-- 3) Inventory Control Notes -->
    <div class="meta-card">
      <section class="inventory-notes" aria-label="Inventory control notes">
        <!-- Header row -->
        <div class="inventory-header">
          <div class="header-text">
            <h2 class="inventory-title">INVENTORY CONTROL NOTES</h2>
            <p class="form-line">FORM NU-IC-12 • DO NOT DUPLICATE</p>
          </div>
          <div class="stamp-small" aria-label="Stamp: AUDITED">AUDITED</div>
        </div>

        <!-- Typed checklist grid -->
        <div class="inventory-grid">
          <div class="grid-row">
            <span class="grid-label">REPRODUCTION:</span>
            <span class="grid-value">{classification}</span>
          </div>
          <div class="grid-row">
            <span class="grid-label">DUPLICATION PERMIT:</span>
            <span class="grid-value">NOT GRANTED</span>
          </div>
          <div class="grid-row">
            <span class="grid-label">CHAIN OF CUSTODY:</span>
            <span class="grid-value">ARCHIVE → FIELD → ARCHIVE</span>
          </div>
          <div class="grid-row">
            <span class="grid-label">LAST AUDIT:</span>
            <span class="grid-value">{displayYear}</span>
          </div>
          <div class="grid-row">
            <span class="grid-label">DISP. STATUS:</span>
            <span class="grid-value">RETURN AFTER PRINT</span>
          </div>
        </div>

        <!-- Handwritten scribble block -->
        {inventoryHtml && (
          <div class="handwritten" set:html={inventoryHtml} />
        )}
      </section>
    </div>

    <!-- 4) Asset grid: preview + actions -->
    <div class="asset-grid">
      <div class="attachment">
        {entry.data.previewImage ? (
          <img src={entry.data.previewImage} alt={`Preview of ${entry.data.title}`} />
        ) : (
          <div class="no-preview">NO PREVIEW AVAILABLE</div>
        )}
      </div>
      
      <div class="actions-panel">
        <a class="download-button" href={entry.data.downloadFile} download>
          DOWNLOAD PRINT FILE
        </a>
        <p class="note">High-resolution PDF for archival purposes</p>
      </div>
    </div>

    <!-- 5) Report body (content) -->
    <article class="report-body" aria-label="Propaganda content" set:html={reportHtml} />

    <!-- 6) Back link -->
    <div class="back-link-container">
      <a class="back-link" href="/propaganda">← Return to Archive Index</a>
    </div>
  </div>
</PropagandaPost>

<style>
  /* ============================================
     CSS VARIABLES - Dossier Palette (Global Tokens)
     ============================================ */
  :root {
    --dossier-paper: var(--color-surface);
    --dossier-dark: var(--color-ink);
    --dossier-red: var(--color-accent);
    --dossier-border: var(--gray-3);
    --dossier-border-subtle: rgba(139, 148, 158, 0.03);
    --dossier-shadow: rgba(0, 0, 0, 0.15);
    --dossier-mono: 'Courier New', Courier, monospace;
    --dossier-serif: Georgia, 'Times New Roman', serif;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 2rem;
  }

  /* ============================================
     DOSSIER CONTAINER
     ============================================ */
  .dossier {
    margin: 0 auto;
    padding: var(--spacing-lg);
    background: var(--dossier-paper);
    position: relative;
  }

  /* Paper texture effect using CSS gradient */
  .dossier::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        var(--dossier-border-subtle) 2px,
        var(--dossier-border-subtle) 4px
      );
    pointer-events: none;
    z-index: 0;
  }

  .dossier > * {
    position: relative;
    z-index: 1;
  }

  /* ============================================
     HEADER: TITLE + STAMP
     ============================================ */
  .dossier-header {
    position: relative;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--dossier-border);
  }

  .dossier-header h1 {
    font-family: var(--dossier-serif);
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.1;
    color: var(--dossier-dark);
    text-transform: uppercase;
    letter-spacing: -0.02em;
    margin: 0 0 var(--spacing-sm) 0;
    max-width: 75%;
  }

  /* Red stamp badge */
  .stamp {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: 3px solid var(--dossier-red);
    color: var(--dossier-red);
    font-family: var(--dossier-mono);
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transform: rotate(-3deg);
    box-shadow: 0 2px 4px var(--dossier-shadow);
    opacity: 0.85;
  }

  /* ============================================
     CLASSIFICATION STRIP
     ============================================ */
  .classification-strip {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    padding: var(--spacing-md);
    background: var(--gray-1);
    border: 1px solid var(--dossier-border);
    border-left: 4px solid var(--dossier-dark);
    margin-bottom: var(--spacing-lg);
  }

  .strip-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 120px;
  }

  .strip-item .label {
    font-family: var(--dossier-mono);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-3);
  }

  .strip-item .value {
    font-family: var(--dossier-mono);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--dossier-dark);
  }

  /* ============================================
     METADATA CARD (now Inventory Control Notes)
     ============================================ */
  .meta-card {
    padding: var(--spacing-md);
    background: var(--gray-1);
    border: 1px solid var(--dossier-border);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    margin-bottom: var(--spacing-lg);
    position: relative;
    /* Add faint ledger/grid background */
    background-image: 
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 19px,
        rgba(139, 148, 158, 0.1) 19px,
        rgba(139, 148, 158, 0.1) 20px
      ),
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 19px,
        rgba(139, 148, 158, 0.08) 19px,
        rgba(139, 148, 158, 0.08) 20px
      );
    background-color: var(--gray-1);
  }

  .inventory-notes {
    margin: 0;
  }

  /* Header row */
  .inventory-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--dossier-dark);
  }

  .header-text {
    flex: 1;
  }

  .inventory-title {
    font-family: var(--dossier-mono);
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--dossier-dark);
    margin: 0 0 0.25rem 0;
  }

  .form-line {
    font-family: var(--dossier-mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--gray-3);
    margin: 0;
  }

  /* Small audited stamp */
  .stamp-small {
    padding: 0.4rem 0.8rem;
    background: transparent;
    border: 2px solid var(--dossier-red);
    color: var(--dossier-red);
    font-family: var(--dossier-mono);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transform: rotate(-5deg);
    opacity: 0.85;
    flex-shrink: 0;
  }

  /* Typed checklist grid */
  .inventory-grid {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    margin-bottom: var(--spacing-md);
    padding: var(--spacing-sm) 0;
  }

  .grid-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--spacing-sm);
    align-items: baseline;
  }

  .grid-label {
    font-family: var(--dossier-mono);
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--gray-3);
    letter-spacing: 0.03em;
  }

  .grid-value {
    font-family: var(--dossier-mono);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dossier-dark);
  }

  /* Handwritten scribble block */
  .handwritten {
    padding: var(--spacing-md);
    background: var(--color-surface);
    border: 1px dashed var(--gray-3);
    border-radius: 2px;
    transform: rotate(-1deg);
    position: relative;
  }

  .handwritten p {
    font-family: "Bradley Hand", "Comic Sans MS", "Segoe Script", cursive;
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--dossier-dark);
    margin: 0 0 0.5rem 0;
  }

  .handwritten p:last-child {
    margin-bottom: 0;
  }

  .handwritten ul,
  .handwritten ol {
    font-family: "Bradley Hand", "Comic Sans MS", "Segoe Script", cursive;
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--dossier-dark);
    margin: 0;
    padding-left: 1.2rem;
  }

  .handwritten li {
    margin-bottom: 0.5rem;
  }

  .handwritten li:last-child {
    margin-bottom: 0;
  }

  /* Redaction bars for flavor */
  .handwritten::before {
    content: '';
    position: absolute;
    top: 25%;
    right: 10%;
    width: 35%;
    height: 2px;
    background: var(--dossier-dark);
    opacity: 0.6;
    transform: rotate(-1deg);
  }

  .handwritten::after {
    content: '';
    position: absolute;
    bottom: 30%;
    left: 15%;
    width: 40%;
    height: 2px;
    background: var(--dossier-dark);
    opacity: 0.6;
    transform: rotate(1deg);
  }

  /* ============================================
     ASSET GRID: PREVIEW + ACTIONS
     ============================================ */
  .asset-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--gray-1);
    border: 1px solid var(--dossier-border);
  }

  /* Photo attachment frame */
  .attachment {
    position: relative;
    background: white;
    padding: 0.75rem;
    box-shadow: 
      0 2px 4px var(--dossier-shadow),
      0 4px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--dossier-border);
    transform: rotate(-0.5deg);
  }

  .attachment img {
    display: block;
    width: 100%;
    height: auto;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .no-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    background: var(--gray-1);
    border: 2px dashed var(--dossier-border);
    font-family: var(--dossier-mono);
    font-size: 0.9rem;
    color: var(--gray-3);
    text-align: center;
  }

  /* Actions panel */
  .actions-panel {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    justify-content: center;
  }

  .download-button {
    display: inline-block;
    padding: 1rem 1.5rem;
    background: var(--dossier-dark);
    color: white;
    font-family: var(--dossier-mono);
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    text-align: center;
    border: 3px solid var(--dossier-dark);
    box-shadow: 0 3px 6px var(--dossier-shadow);
    transition: all 0.2s ease;
  }

  .download-button:hover {
    background: var(--dossier-red);
    border-color: var(--dossier-red);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px var(--dossier-shadow);
  }

  .download-button:focus {
    outline: 3px solid var(--dossier-red);
    outline-offset: 3px;
  }

  .note {
    font-family: var(--dossier-serif);
    font-size: 0.85rem;
    color: var(--gray-3);
    font-style: italic;
    margin: 0;
    line-height: 1.5;
  }

  /* ============================================
     REPORT BODY (MARKDOWN CONTENT)
     ============================================ */
  .report-body {
    max-width: 720px;
    margin: 0 auto var(--spacing-lg);
    padding: var(--spacing-lg);
    background: var(--color-surface);
    border-left: 3px solid var(--dossier-dark);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .report-body :global(p) {
    font-family: var(--dossier-serif);
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--dossier-dark);
    margin-bottom: var(--spacing-md);
  }

  .report-body :global(h2),
  .report-body :global(h3),
  .report-body :global(h4) {
    font-family: var(--dossier-serif);
    color: var(--dossier-dark);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
  }

  .report-body :global(ul),
  .report-body :global(ol) {
    font-family: var(--dossier-serif);
    line-height: 1.7;
    margin-bottom: var(--spacing-md);
    padding-left: 1.5rem;
  }

  .report-body :global(blockquote) {
    border-left: 4px solid var(--dossier-border);
    padding-left: var(--spacing-md);
    margin-left: 0;
    font-style: italic;
    color: var(--gray-3);
  }

  /* ============================================
     BACK LINK
     ============================================ */
  .back-link-container {
    text-align: center;
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--dossier-border);
  }

  .back-link {
    display: inline-block;
    font-family: var(--dossier-mono);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--dossier-dark);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border: 1px solid var(--dossier-border);
    background: var(--color-surface);
    transition: all 0.2s ease;
  }

  .back-link:hover {
    background: var(--dossier-dark);
    color: white;
    border-color: var(--dossier-dark);
  }

  .back-link:focus {
    outline: 2px solid var(--dossier-dark);
    outline-offset: 2px;
  }

  /* ============================================
     RESPONSIVE DESIGN
     ============================================ */
  @media (max-width: 720px) {
    .dossier {
      padding: var(--spacing-md);
    }

    .dossier-header h1 {
      font-size: 1.75rem;
      max-width: 60%;
    }

    .stamp {
      font-size: 0.75rem;
      padding: 0.5rem 1rem;
    }

    .classification-strip {
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .strip-item {
      min-width: auto;
    }

    .inventory-header {
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .stamp-small {
      align-self: flex-start;
    }

    .grid-row {
      grid-template-columns: 1fr;
      gap: 0.2rem;
    }

    .handwritten {
      transform: rotate(0);
      padding: var(--spacing-sm);
    }

    .handwritten p {
      font-size: 0.85rem;
    }

    .asset-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
    }

    .attachment {
      transform: rotate(0);
    }

    .report-body {
      padding: var(--spacing-md);
    }

    .report-body :global(p) {
      font-size: 1rem;
    }
  }
</style>
